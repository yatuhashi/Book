#OpenFlowについて
マスタリングTCP/IP(OpenFlow編)を読んでメモするなり  
要点だけを書いていくので、実際になんの操作が出来るのかとかパケットの中身をみたい場合は、本の購入をオススメします

---

1. OpenFlowの概要
    1. OpenFlowバージョンについて
        - 1.3が相互運用性を確保するバージョンなので1.3で揃えるのが楽そう
        
    2. コントロールプレーンとデータプレーンを分離する
        * コントロールプレーン
           - OpenflowコントローラーとOpenflowスイッチはOpenflowチャンネルでTCP接続を行っている
        * データプレーン構築手法
           - Hop-by-Hop方式
           - オーバレイ方式
           - ハイブリッド方式
    
    3. フローテーブル
        * パケットをどう処理するするのかとか処理が行われた回数などを記録を記述するもの
        * 各フローの挙動そのものを個別に定義しているのがフローエントリ
        * 各スイッチは複数のフローテーブルを持つことができる
    
    4. スイッチの初期動作
        * プロアクティブ型設定
            - OpenFlowチャンネル確立後、コントローラーからスイッチにフローエントリを流す設定
        * リアクティブ型設定
            - スイッチが未知のパケットを受け取った時にコントローラーに聞きにいくかの設定(セキュアチャンネルでPacket-Inメッセージ)

2. OpenFlow1.0の仕組み

    - 2-1. フローテーブルとフローエントリ
        * フローエントリは
            - ヘッダーフィールド・・・パケットのマッチ規則
            - カウンタ・・・マッチ回数
            - アクション・・・マッチしたパケットに対する操作  
        の基本要素によって構築されている(バージョンによって違う)
        * 1.0ではマッチするエントリは１つだが1.1ではテーブルごとにマッチする(1.1では複数のエントリにマッチする)
        * 1.0ではカウンタに以下の種類がある
            - フローテーブルごと
            - 物理ポートごと
            - フローエントリごと
            - Queueごと
        * アクション
            - ０個以上の定義ができ０個だと破棄される
            - 順番に実行される
            - 以下の4種類がある
                - Forward・・・パケット転送
                - Drop・・・破棄
                - Enqueue・・・Queueへの転送
                - Modify-Field(1.1からはSet-Field)・・・パケットの中身を書き換える
    
        ToS,Cosに関する注意:P. 33
    
    - 2-2. コントローラーとスイッチ間のやりとり
        * セキュアチャンネルの確立
            - コントロールプレーン用のネットワークを通じて張られる
            - スイッチのエントリによる影響を受けない
            - TLSを用いて張られ、証明書が必要
            - 平文でも可能(1.1から)
            - デフォルトport 6633
            - コントローラーのportとIPをスイッチに設定する必要がある
        * コントローラーとスイッチの初期動作
            1. コネクション確立
            2. OpenFlowバージョンの決定(HELLOメッセージで低いバージョンの方に合わせる)
            3. ハンドシェイク(FEATURE)
            4. その他の任意のやりとり
        * Flow-Modメッセージ
            - コントローラーからスイッチに対してフローエントリを行うためのメッセージ
            - 追加、削除、変更が可能(コマンドは５種類)ワイルドカード指定も可能
                1. OFPFC_ADD・・・追加
                2. OFPFC_MODIFY・・・変更
                3. OFPFC_MODIFY_STRICT・・・完全一致したエントリの変更
                4. OFPFC_DELETE・・・削除
                5. OFPFC_DELETE_STRICT・・・完全一致したエントリの削除  
        1.2以前ではMODIFYでなかったものは追加されたが以降は廃止
        ※フローエントリにタイムアウト機能を持たせておけて、時間削除できる
        * Packet-Inメッセージ(スイッチからコントローラーへ)
            - コントローラーに送信する要因は二つ
                1. フローテーブルにない場合
                2. エントリにコントローラーに送信と書いてあった場合
            - メッセージ送信時にスイッチがパケットをバッファする場合としない場合がある
            - バッファにある場合はbuffer_idが正でない場合は、-1
            - バッファが削除された時にコントローラーに通知する仕組みがないのでつらい
        * Packet-Outメッセージ
            - buffer_idを指定し、コントローラーからパケット操作する事が可能
            - コントローラーが作ったパケットを送信する事も可能(buffer_id=-1)
        * Port-Statusメッセージ
            - 物理ポートの追加、削除、変更が行われるとコントローラーに送信
        * Flow-Removedメッセージ
            -  フローエントリがタイムアウトした時にスイッチからコントローラーに対して送信される
        * Errorメッセージ
            - なんらかのエラーを送信するメッセージ
        * Barrierメッセージ
            - Barrierメッセージを利用する事で相手がどこまで処理したのかが分かる
        * Echoメッセージ
            - コントローラーとスイッチの生存確認メッセージ

3. LLDPとOpenFlow
    * LLDPって？
        - L2の接続検出、管理するプロトコル  802.1AB
        - OpenFlowコントローラーはLLDPでネットワークトポロジ検出を行う
    * OpenFlowでのLLDP処理概要
        - 流れ
            1. コントローラーがスイッチに対してLLDPフレームを送信するためのPacket-Outメッセージを送る
            2. 受け取ったスイッチがLLDPを他のスイッチに流す
            3. LLDPを受けとったスイッチがコントローラーにPacket-Inメッセージを送る  
        ※ IS-ISやOSPFで検出する事も可能
    * LLDPの仕組み
        - L2のマルチキャストアドレスに一定時間ごとにLLDPフレームを送信
        - LLDPフレームの送信元アドレスは装置のイーサネットアドレス
        - 装置などの識別番号、ポート番号を一方的に送信
    * OpenFlowでの設定
        - LLDPのイーサネットアドレスは0x88ccなのでそれをフローエントリにコントローラーに送ると登録しておく必要がある   
    ####※デフォルトで1.2までは未知のパケットはコントローラーに送っていたが1.3では破棄になっているので注意が必要
    * LLDPでの基本マルチキャストイーサネットアドレスはNearestBridgeだがOpenFlowスイッチではないスイッチを挟んだ場合はNearest non-TPMR Bridgeなど
    * LLDPDU
        - LLDPのペイロード部
        - TLV(Tag Length Value)の構造体  
    ※実際の活用例:P68
    * LLDPで収集した経路をダイクストラでとく

4. 具体的なネットワーク機器を再現してみる
    * リピータHUBの再現
    * ラーニングブリッジの再現
        - コントローラーに送りエントリを自動作成していく
        - APRを監視して、エントリ作成
    * タグドVLANの再現

5. OpenFlowと仮想化
    * ライブマイグレーション便利だよね
        - でも、物理ネットワークの変更って大変だよね
        - ネットワーク仮想化できたら便利やん
        - VRFとかもあるよね
        - OpenFlowだったらネットワーク変更効くし、ライブマイグレーションで移動しやすいよね
    * FlowVisor
        - OpenFlowコントローラーが把握したり制御するものが多くなった時に区分わけする仕組み
        - コントローラーのリバースプロキシみたいなものでスイッチ群とコントローラー群の間におく
        - コントローラーとスイッチのチャンネルは個別である?
        - FlowVisorを複数にして多段にする事も可能

6. ユースケースで考えるOpenFlow
    * ECMP実現(複数のパスがある場合)
        - 送信元アドレスでわける
        - OpenFlow1.1以降だとグループテーブルのselectを利用したりハッシュによるフロー選定よりラウンドロビンが可能になる
    * OpenFlowスイッチを簡易ロードバランサーにする事が可能
        - IPの書き換えなんかもできるので

7. OpenFlow1.1における変更点
    * 変更点一覧
        1. マッチフィールドの変更
        2. マッチテーブルしようの変更、パイプライン処理
        3. インストラクションの導入
        4. グループ
        5. 仮想ポートの拡張
        6. TTLフィールドの操作
        7. MPLSタグとVLANタグのpush/pop対応(多段VLAN,QinQが可能に)
        8. OpenFlowハイブリッドスイッチ
        9. SCTP対応
        10. ECN対応
        11. コントローラーとスイッチの接続名変更(セキュアチャンネル→OpenFlowチャンネル)
        12. 緊急自体フローキャッシュの廃止
        13. Vendorメッセージの名称変更
    * パイプライン処理
        - テーブル0から複数のテーブルにマッチする
        - アクションセットというものがあり、マッチしたアクションを追加していき、全て終わったら優先順にアクションを起こしていく。（優先順位は本を参照
        - 多段VLANなんかもできる
    * メタデータ
        - マッチフィールドにメタデータフィールドが追加
        - メタデータフィールドを用いてフローテーブル間で情報伝達が可能
        - 64bit 自由に使える
        - flag管理して、flagが複数たっている時はOutputするとかも可能
    * インストラクション
        - フローエントリの構成要素が以下のようになった
            * マッチフィールド
            * カウンタ
            * インストラクション
        - パケットを操作できるアクションが複数になり、追加や編集、削除やメタデータ操作、GoToテーブルなど多様化した
        - アクションセットとアクションリストは無関係
    * グループ  
        複数のポートを一つのグループとして扱えたりする
        * グループテーブル・・複数のグループエントリを保持するもの
        * グループエントリ
        * グループタイプ
            - all
            - select
            - indirect
            - fast failover
        * グループのグループ
    * 仮想ポートの拡張
        - LAG,トンネル,ループバックも仮想ポートとして使えるようになった
        - ポート番号の識別子が16bitから32bitに変更

8. OpenFlow1.2における変更点
    * 一覧
        1. OXMの採用
        2. 基本的なIPv6に対応
        3. 複数コントローラー対応
        4. 仮想ポートがロジカルポートと予約ポートに分離
        5. Flow-Modの仕様変更
        6. 実験的拡張への対応
    * OXM
        - 固定長のマッチフィールドの代わりにTLV構造が採用
    * 複数コントローラー
        - 3種のRoleが存在する
            1. EQUAL(default all)
            2. MASTER(all 一つのスイッチに１つしかできない.EQUALとは共存可能)
            3. SLAVE(Read Only)

9. OpenFlow1.3における変更点
    * 一覧
        1. メーターテーブル追加(QoS実現)
        2. テーブルミスのデフォがパケット破棄に()
        3. コントローラーとスイッチの補助接続
        4. IPv6拡張ヘッダ対応
        5. OXMマッチフィールドの追加
        6. PBB対応
        7. マルチパートフレームワーク
        8. フローエントリの構成要素変更
    * 補助接続
        - 一つのスイッチが一つのコントローラーに並列接続可能に
    * スイッチとコントローラーがUDPやDTLSでやりとり可能に




